<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Welcome to auth bridge!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      pre {
        background-color: lightgray;
        padding: 10px;
        width: 450px;
      }
      iframe {
        width: 500px;
        height: 250px;
      }
      button {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <h2>Auth bridge (auth-bridge.learning-web.rocks)</h2>
    <label>localStorage:</label>
    <button id="refresh">Refresh</button>
    <button id="clear" style="margin-right: 30px">Clear</button>
    <label>Storage Access API:</label>
    <span id="storageStatus">Checking status...</span>

    <pre id="localStorageOutput"></pre>

    <!-- Common script -->
    <script>
      const refresh = document.getElementById('refresh');
      const clear = document.getElementById('clear');
      const localStorageOutput = document.getElementById('localStorageOutput');

      function displayLocalStorage() {
        const output = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          output.push(`${key}: ${value}`);
        }
        localStorageOutput.innerText = output.join('\n');
      }

      refresh.addEventListener('click', displayLocalStorage);

      clear.addEventListener('click', function() {
        localStorage.clear();
        displayLocalStorage();
      });

      displayLocalStorage();
    </script>

    <!-- Auth bridge script -->
    <script>
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SET_TOKEN') {
          localStorage.setItem('token', event.data.token);
          displayLocalStorage();
        } else if (event.data && event.data.type === 'GET_TOKEN') {
          const token = localStorage.getItem('token') || '';
          event.source.postMessage({ type: 'TOKEN_RESPONSE', token }, '*');
        }
      });
      const storageStatus = document.getElementById('storageStatus');

      async function requestAccessWithUserGesture() {
        try {
          await document.requestStorageAccess();
        } catch (error) {
          storageStatus.innerHTML = `<span style="color: red">Access denied: ${error.message}</span>`;
        }
      }
      async function checkStorageAccess() {
        try {
          const hasStorageAccess = await document.hasStorageAccess();
          if (hasStorageAccess) {
            storageStatus.innerHTML = '<span style="color: green">Access granted</span>';
          } else {
            storageStatus.innerHTML = '<button onclick="requestAccessWithUserGesture()">Request access</button>';
          }
        } catch (error) {
          storageStatus.innerHTML = `<span style="color: red">Error: ${error.message}</span>`;
        }
      }
      checkStorageAccess();
    </script>
  </body>
</html>
